{"version":3,"sources":["webpack:///./src/views/Chat.vue","webpack:///./src/apis/messages.js","webpack:///./src/views/Chat.vue?7f7d","webpack:///./node_modules/core-js/modules/es.array.find.js","webpack:///./src/views/Chat.vue?b763"],"names":["class","style","role","id","currentUser","name","isFetchFriendsLoading","friends","friend","key","to","src","avatar","alt","isOnline","lastMessage","isChatUser","chattingUser","isFetchMessagesLoading","messages","message","action","handleSubmit","placeholder","submitOnEnter","updateTextareaHeight","rows","getMessages","chattingUserId","apiHelper","get","setup","route","userId","params","value","onlineUsersId","updateLastMessage","data","map","senderId","receiverId","setOverflowAtTheEnd","messageBox","document","getElementById","messageBox2","scrollTop","scrollHeight","updateOnlineUsersId","updateIsOnlineInFriends","d","includes","updateMessages","push","fetchMessages","fire","icon","title","console","log","fetchFriends","users","getFriends","length","store","baseURL","ws","wsConnect","WebSocket","state","token","onopen","onclose","onmessage","event","JSON","parse","Number","status","messageStatus","wsSend","send","newValue","find","f","Object","assign","trim","String","readyState","close","methods","textarea","getElementsByClassName","height","substring","e","which","shiftKey","target","form","dispatchEvent","Event","cancelable","preventDefault","computed","render","$","$find","addToUnscopables","FIND","SKIPS_HOLES","Array","proto","forced","callbackfn","this","arguments","undefined"],"mappings":"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","file":"js/chunk-3dc730e8.5c6e0f81.js","sourcesContent":["<template>\r\n  <div\r\n    class=\"\r\n        py-4\r\n        col-xxl-7 col-xl-7 col-lg-8 col-md-9 col-sm-10 col-12\r\n        mx-auto\r\n      \"\r\n  >\r\n    <!--  Dimensions > 576px(sm) -->\r\n    <div class=\"d-none d-sm-block\">\r\n      <div class=\"row min-height-80vh bg-white\">\r\n        <aside\r\n          class=\"col-xxl-4 col-xl-4 col-lg-4 col-md-4 col-sm-4 padding-none border\"\r\n        >\r\n          <div\r\n            class=\"d-flex justify-content-center align-items-center border-bottom h-65px\"\r\n          >\r\n            <span class=\"fs-4\">{{ currentUser.name }}</span>\r\n          </div>\r\n          <div v-if=\"!isFetchFriendsLoading\" class=\"d-flex flex-column\">\r\n            <router-link\r\n              class=\"chat-user\"\r\n              v-for=\"friend in friends\"\r\n              :key=\"friend.id\"\r\n              :to=\"{\r\n                name: 'chat-with-user',\r\n                params: { chattingUserId: friend.id },\r\n              }\"\r\n              ><div>\r\n                <div class=\"position-relative\">\r\n                  <img :src=\"friend.avatar\" alt=\"avatar\" class=\"avatar\" />\r\n                  <div :class=\"friend.isOnline ? 'online' : 'offline'\">\r\n                    <div></div>\r\n                  </div>\r\n                </div>\r\n                <div class=\"ms-2\">\r\n                  <span class=\"\">{{ friend.name }}</span>\r\n                  <span v-if=\"friend.lastMessage\" class=\"last-message\">{{\r\n                    friend.lastMessage\r\n                  }}</span>\r\n                  <span v-else class=\"last-message\">\r\n                    尚無聊天訊息\r\n                  </span>\r\n                </div>\r\n              </div></router-link\r\n            >\r\n          </div>\r\n          <div\r\n            v-else\r\n            class=\"d-flex justify-content-center align-items-center\"\r\n            style=\"height: 100%; width: 100%;\"\r\n          >\r\n            <div\r\n              class=\"spinner-border text-primary mx-auto my-auto\"\r\n              role=\"status\"\r\n            >\r\n              <span class=\"visually-hidden\">Loading...</span>\r\n            </div>\r\n          </div>\r\n        </aside>\r\n        <div\r\n          class=\"col-xxl-8 col-xl-8 col-lg-8 col-md-8 col-sm-8 padding-none border-top border-end border-bottom\"\r\n        >\r\n          <div v-if=\"isChatUser\" class=\"chat-window\">\r\n            <div>\r\n              <span class=\"fs-4\">{{ chattingUser.name }}</span>\r\n            </div>\r\n            <div>\r\n              <div id=\"messageBox\" v-if=\"!isFetchMessagesLoading\">\r\n                <div\r\n                  v-for=\"message in messages\"\r\n                  :key=\"message.id\"\r\n                  :class=\"message.class\"\r\n                >\r\n                  <div>\r\n                    <img\r\n                      v-if=\"message.class === 'received'\"\r\n                      :src=\"chattingUser.avatar\"\r\n                      alt=\"avatar\"\r\n                    />\r\n                    <span>{{ message.message }}</span>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n              <div\r\n                v-else\r\n                class=\"d-flex justify-content-center align-items-center\"\r\n                style=\"height: calc(80vh - 127px); width: 100%;\"\r\n              >\r\n                <div\r\n                  class=\"spinner-border text-primary mx-auto my-auto\"\r\n                  role=\"status\"\r\n                >\r\n                  <span class=\"visually-hidden\">Loading...</span>\r\n                </div>\r\n              </div>\r\n            </div>\r\n            <div class=\"chat-form\">\r\n              <form action=\"POST\" @submit.prevent=\"handleSubmit\">\r\n                <textarea\r\n                  placeholder=\"訊息......\"\r\n                  v-model=\"message\"\r\n                  @keypress=\"submitOnEnter\"\r\n                  @input=\"updateTextareaHeight\"\r\n                  class=\"textarea\"\r\n                  rows=\"1\"\r\n                ></textarea>\r\n              </form>\r\n            </div>\r\n          </div>\r\n          <div\r\n            v-else\r\n            class=\"h-100 d-flex justify-content-center align-items-center\"\r\n          >\r\n            <div class=\"text-center\">\r\n              <div class=\"mb-2\">\r\n                <i class=\"fab fa-3x fa-facebook-messenger\"></i>\r\n              </div>\r\n              <h2>你的訊息</h2>\r\n              <span>傳送訊息給朋友</span>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n\r\n    <!--  Dimensions < 576px(sm) -->\r\n    <div class=\"flex d-block d-sm-none\">\r\n      <div class=\"row min-height-80vh bg-white xs\">\r\n        <div v-if=\"isChatUser\" class=\"chat-window\">\r\n          <div>\r\n            <span class=\"fs-4\">{{ chattingUser.name }}</span>\r\n          </div>\r\n          <div>\r\n            <div id=\"messageBox\" v-if=\"!isFetchMessagesLoading\">\r\n              <div\r\n                v-for=\"message in messages\"\r\n                :key=\"message.id\"\r\n                :class=\"message.class\"\r\n              >\r\n                <div>\r\n                  <img\r\n                    v-if=\"message.class === 'received'\"\r\n                    :src=\"chattingUser.avatar\"\r\n                    alt=\"avatar\"\r\n                  />\r\n                  <span>{{ message.message }}</span>\r\n                </div>\r\n              </div>\r\n            </div>\r\n            <div v-else class=\"\" style=\"height: calc(80vh - 127px);\">\r\n              <div class=\"spinner-border text-primary\" role=\"status\">\r\n                <span class=\"visually-hidden\">Loading...</span>\r\n              </div>\r\n            </div>\r\n          </div>\r\n          <div class=\"chat-form\">\r\n            <form action=\"POST\" @submit.prevent=\"handleSubmit\">\r\n              <textarea\r\n                placeholder=\"訊息......\"\r\n                v-model=\"message\"\r\n                @keypress=\"submitOnEnter\"\r\n                @input=\"updateTextareaHeight\"\r\n                class=\"textarea\"\r\n                rows=\"1\"\r\n              ></textarea>\r\n            </form>\r\n          </div>\r\n        </div>\r\n\r\n        <!-- friends box -->\r\n        <aside v-else class=\"padding-none border friends-box bg-white\">\r\n          <div\r\n            class=\"d-flex justify-content-center align-items-center border h-65px\"\r\n          >\r\n            <span class=\"fs-4\">{{ currentUser.name }}</span>\r\n          </div>\r\n          <div class=\"d-flex flex-column\">\r\n            <router-link\r\n              class=\"chat-user\"\r\n              v-for=\"friend in friends\"\r\n              :key=\"friend.id\"\r\n              :to=\"{\r\n                name: 'chat-with-user',\r\n                params: { chattingUserId: friend.id },\r\n              }\"\r\n              ><div>\r\n                <div class=\"position-relative\">\r\n                  <img :src=\"friend.avatar\" alt=\"avatar\" class=\"avatar\" />\r\n                  <div :class=\"friend.isOnline ? 'online' : 'offline'\">\r\n                    <div></div>\r\n                  </div>\r\n                </div>\r\n                <div class=\"ms-2\">\r\n                  <span class=\"\">{{ friend.name }}</span>\r\n                  <span v-if=\"friend.lastMessage\" class=\"last-message\">{{\r\n                    friend.lastMessage\r\n                  }}</span>\r\n                  <span v-else class=\"last-message\">\r\n                    尚無聊天訊息\r\n                  </span>\r\n                </div>\r\n              </div></router-link\r\n            >\r\n          </div>\r\n        </aside>\r\n      </div>\r\n    </div>\r\n  </div>\r\n</template>\r\n\r\n<script>\r\nimport { ref, computed, watch, onMounted, nextTick } from \"vue\";\r\nimport { mapState, useStore } from \"vuex\";\r\nimport { onBeforeRouteLeave, onBeforeRouteUpdate, useRoute } from \"vue-router\";\r\nimport { Toast } from \"./../utils/helpers.js\";\r\nimport usersAPI from \"./../apis/users.js\";\r\nimport messagesAPI from \"./../apis/messages.js\";\r\n\r\nexport default {\r\n  name: \"Chat\",\r\n  setup() {\r\n    let isFetchFriendsLoading = ref(false);\r\n    let isFetchMessagesLoading = ref(false);\r\n\r\n    const route = useRoute();\r\n    const userId = route.params.id;\r\n\r\n    let chattingUserId = computed(() => route.params.chattingUserId);\r\n    let isChatUser = computed(() => (chattingUserId.value ? true : false));\r\n\r\n    let friends = ref([]);\r\n    let onlineUsersId = ref([]);\r\n\r\n    let messages = ref([]);\r\n\r\n    const updateLastMessage = (data) => {\r\n      friends.value = friends.value.map((friend) => {\r\n        if (friend.id === data.senderId || friend.id === data.receiverId) {\r\n          friend.lastMessage = data.message;\r\n        }\r\n        return friend;\r\n      });\r\n    };\r\n\r\n    const setOverflowAtTheEnd = () => {\r\n      let messageBox = document.getElementById(\"messageBox\");\r\n      let messageBox2 = document.getElementById(\"messageBox2\");\r\n\r\n      if (messageBox !== null) {\r\n        messageBox.scrollTop = messageBox.scrollHeight;\r\n      }\r\n      if (messageBox2 !== null) {\r\n        messageBox2.scrollTop = messageBox2.scrollHeight;\r\n      }\r\n    };\r\n\r\n    const updateOnlineUsersId = (data) => {\r\n      onlineUsersId.value = data;\r\n    };\r\n\r\n    const updateIsOnlineInFriends = (onlineUsersId) => {\r\n      friends.value = friends.value.map((d) => {\r\n        return {\r\n          ...d,\r\n          isOnline: onlineUsersId.includes(d.id),\r\n        };\r\n      });\r\n    };\r\n\r\n    const updateMessages = async (data) => {\r\n      messages.value.push(data);\r\n\r\n      await nextTick();\r\n      setOverflowAtTheEnd();\r\n    };\r\n\r\n    const fetchMessages = async () => {\r\n      try {\r\n        isFetchMessagesLoading.value = true;\r\n\r\n        let { data } = await messagesAPI.getMessages({\r\n          chattingUserId: chattingUserId.value,\r\n        });\r\n\r\n        messages.value = data.messages;\r\n\r\n        isFetchMessagesLoading.value = false;\r\n      } catch (error) {\r\n        isFetchMessagesLoading.value = false;\r\n        Toast.fire({\r\n          icon: \"error\",\r\n          title: \"無法取得聊天紀錄，請稍後再試\",\r\n        });\r\n\r\n        console.log(\"Error: \", error);\r\n      }\r\n    };\r\n\r\n    const fetchFriends = async () => {\r\n      try {\r\n        isFetchFriendsLoading.value = true;\r\n        let { data } = await usersAPI.getFriends({ userId });\r\n        if (onlineUsersId.value.length) {\r\n          data = data.map((d) => {\r\n            return {\r\n              ...d,\r\n              isOnline: onlineUsersId.value.includes(d.id),\r\n            };\r\n          });\r\n        }\r\n        friends.value = data;\r\n        isFetchFriendsLoading.value = false;\r\n      } catch (error) {\r\n        isFetchFriendsLoading.value = false;\r\n        Toast.fire({\r\n          icon: \"error\",\r\n          title: \"無法取得好友列表，請稍後再試\",\r\n        });\r\n\r\n        console.log(\"Error: \", error);\r\n      }\r\n    };\r\n\r\n    let chattingUser = ref({});\r\n\r\n    const store = useStore();\r\n    // const baseURL = \"ws://localhost:3000/\";\r\n    const baseURL = \"wss://simple-twitter-project-api.herokuapp.com/\";\r\n    let ws = ref({});\r\n\r\n    const wsConnect = (chattingUserId) => {\r\n      ws.value = new WebSocket(\r\n        baseURL + \"?chattingUserId=\" + chattingUserId,\r\n        store.state.token\r\n      );\r\n\r\n      ws.value.onopen = () => {};\r\n\r\n      ws.value.onclose = () => {};\r\n\r\n      ws.value.onmessage = (event) => {\r\n        let data = JSON.parse(event.data);\r\n        if (data.onlineUsersId) {\r\n          updateOnlineUsersId(data.onlineUsersId);\r\n        }\r\n\r\n        if (data.message) {\r\n          if (\r\n            Number(data.message.senderId) === Number(chattingUserId) ||\r\n            Number(data.message.receiverId) === Number(chattingUserId)\r\n          ) {\r\n            data.message.class = data.status ? \"sent\" : \"received\";\r\n            data.message.messageStatus =\r\n              data.status === \"success\" ? true : false;\r\n\r\n            updateMessages(data.message);\r\n          }\r\n\r\n          updateLastMessage(data.message);\r\n        }\r\n      };\r\n    };\r\n\r\n    const wsSend = (message) => {\r\n      ws.value.send(message);\r\n    };\r\n\r\n    watch(chattingUserId, async (newValue) => {\r\n      if (newValue === \"undefined\" || !newValue) {\r\n        chattingUser.value = {};\r\n        onlineUsersId.value = [];\r\n      } else {\r\n        let friend = friends.value.find((f) => f.id === Number(newValue));\r\n        chattingUser.value = Object.assign({}, friend);\r\n        if (isChatUser.value) {\r\n          wsConnect(chattingUserId.value);\r\n          fetchFriends();\r\n          await fetchMessages();\r\n          setOverflowAtTheEnd();\r\n        }\r\n      }\r\n    });\r\n\r\n    watch(onlineUsersId, (newValue) => {\r\n      updateIsOnlineInFriends(newValue);\r\n    });\r\n\r\n    let message = ref(\"\");\r\n\r\n    const handleSubmit = () => {\r\n      if (message.value.trim()) {\r\n        wsSend(String(message.value));\r\n        message.value = \"\";\r\n      }\r\n    };\r\n\r\n    onBeforeRouteUpdate(() => {\r\n      if (ws.value.readyState) {\r\n        ws.value.close();\r\n      }\r\n    });\r\n\r\n    onBeforeRouteLeave(() => {\r\n      if (ws.value.readyState) {\r\n        ws.value.close();\r\n      }\r\n    });\r\n\r\n    onMounted(async () => {\r\n      fetchFriends();\r\n      await fetchMessages();\r\n      setOverflowAtTheEnd();\r\n      if (isChatUser.value) {\r\n        wsConnect(chattingUserId.value);\r\n      }\r\n    });\r\n\r\n    return {\r\n      isFetchMessagesLoading,\r\n      isFetchFriendsLoading,\r\n      friends,\r\n      messages,\r\n      isChatUser,\r\n      chattingUserId,\r\n      chattingUser,\r\n      message,\r\n      handleSubmit,\r\n      ws,\r\n      wsSend,\r\n      onlineUsersId,\r\n    };\r\n  },\r\n  methods: {\r\n    updateTextareaHeight() {\r\n      let textarea = document.getElementsByClassName(\"textarea\");\r\n      let height = [\r\n        textarea[0].style.height.substring(\r\n          0,\r\n          textarea[0].style.height.length - 2\r\n        ),\r\n        textarea[1].style.height.substring(\r\n          0,\r\n          textarea[1].style.height.length - 2\r\n        ),\r\n      ];\r\n      console.log(height);\r\n      // if (height[0] > 128) {\r\n      //   textarea[0].style[\"overflow-y\"] = \"auto\";\r\n      // }\r\n      // if (height[1] > 128) {\r\n      //   textarea[1].style[\"overflow-y\"] = \"auto\";\r\n      // }\r\n\r\n      textarea[0].style.height = \"auto\";\r\n      textarea[0].style.height = textarea[0].scrollHeight + \"px\";\r\n\r\n      textarea[1].style.height = \"auto\";\r\n      textarea[1].style.height = textarea[1].scrollHeight + \"px\";\r\n    },\r\n    submitOnEnter(e) {\r\n      if (e.which === 13 && !e.shiftKey) {\r\n        e.target.form.dispatchEvent(new Event(\"submit\", { cancelable: true }));\r\n        e.preventDefault();\r\n      }\r\n    },\r\n  },\r\n  computed: {\r\n    ...mapState([\"currentUser\", \"isAuthenticated\", \"token\"]),\r\n  },\r\n};\r\n</script>\r\n\r\n<style>\r\n.position-relative {\r\n  position: relative;\r\n}\r\naside {\r\n  max-height: 80vh;\r\n}\r\naside > div:nth-child(2) {\r\n  max-height: calc(80vh - 65px);\r\n  overflow-y: auto;\r\n}\r\n.online {\r\n  position: absolute;\r\n  bottom: 0;\r\n  right: 0;\r\n  height: 12px;\r\n  width: 12px;\r\n  border-radius: 6px;\r\n  background-color: #fff;\r\n}\r\n.online > div {\r\n  margin: 1px;\r\n  height: 10px;\r\n  width: 10px;\r\n  border-radius: 5px;\r\n  background-color: #31a24c;\r\n}\r\n.offline {\r\n  position: absolute;\r\n  bottom: 0;\r\n  right: 0;\r\n  height: 12px;\r\n  width: 12px;\r\n  border-radius: 6px;\r\n  background-color: #fff;\r\n}\r\n.offline > div {\r\n  margin: 1px;\r\n  height: 10px;\r\n  width: 10px;\r\n  border-radius: 5px;\r\n  background-color: #777;\r\n}\r\n.xs {\r\n  max-width: 88%;\r\n  margin: auto;\r\n}\r\n.chat-window {\r\n  height: 80vh;\r\n  max-height: 80vh;\r\n  display: flex;\r\n  flex-direction: column;\r\n  align-items: stretch;\r\n}\r\n.chat-window > div:nth-child(1) {\r\n  display: flex;\r\n  justify-content: center;\r\n  align-items: center;\r\n  border-bottom: 1px solid #dee2e6;\r\n  min-height: 65px;\r\n  align-self: stretch;\r\n}\r\n.chat-window > div:nth-child(2) {\r\n  margin-top: auto;\r\n  overflow-y: auto;\r\n  display: flex;\r\n  flex-direction: column;\r\n}\r\n.chat-window > div > div:nth-child(1) {\r\n  margin-top: auto;\r\n}\r\n.chat-form {\r\n  align-self: center;\r\n  width: 90%;\r\n  margin: 15px 0;\r\n}\r\n.chat-form form {\r\n  display: flex;\r\n  flex-direction: row;\r\n  border: 1px solid #dee2e6;\r\n  border-radius: 20px;\r\n}\r\n.chat-form form textarea {\r\n  outline: 0;\r\n  resize: none;\r\n  width: 85%;\r\n  border: 0px;\r\n  border-radius: 20px;\r\n  padding: 4px 20px;\r\n  max-height: 104px;\r\n  overflow-y: auto;\r\n}\r\n.chat-form button {\r\n  color: #0571ed;\r\n  border: 0px;\r\n  border-radius: 20px;\r\n  background-color: white;\r\n}\r\n.min-height-80vh {\r\n  min-height: 80vh;\r\n}\r\n.h-65px {\r\n  height: 65px;\r\n}\r\n.avatar {\r\n  max-height: 50px;\r\n  width: 50px;\r\n  border-radius: 25px;\r\n}\r\ndiv a.d-block:hover {\r\n  /* background-color: rgb(199, 199, 199); */\r\n  background-color: #f0f2f5;\r\n  text-decoration: none;\r\n}\r\ndiv a.d-block.active {\r\n  /* background-color: rgb(199, 199, 199); */\r\n  background-color: #f0f2f5;\r\n}\r\n.friends-box {\r\n  width: 80%;\r\n  margin-left: auto;\r\n  margin-right: auto;\r\n}\r\n.message-box {\r\n  /* display: none; */\r\n  width: 80%;\r\n  margin-left: auto;\r\n  margin-right: auto;\r\n}\r\n#messageBox,\r\n#messageBox2 {\r\n  overflow-y: auto;\r\n  overflow-x: hidden;\r\n}\r\n.sent {\r\n  padding: 5px 0;\r\n  width: 100%;\r\n  text-align: right;\r\n}\r\n.sent span {\r\n  display: inline-block;\r\n  height: 100%;\r\n  max-width: 60%;\r\n  margin-right: 0 20px 0 30%;\r\n  background-color: #f0f2f5;\r\n  padding: 10px 10px;\r\n  border-radius: 20px;\r\n  margin: auto 20px auto auto;\r\n  overflow-x: hidden;\r\n  word-wrap: break-word;\r\n}\r\n.received {\r\n  margin-left: 20px;\r\n  padding: 5px 0;\r\n  text-align: left;\r\n}\r\n.received div {\r\n  display: flex;\r\n  justify-content: flex-start;\r\n  align-content: space-around;\r\n  flex-direction: row;\r\n  align-items: flex-start;\r\n}\r\n.received span {\r\n  display: inline-block;\r\n  height: 100%;\r\n  max-width: 60%;\r\n  background-color: #f0f2f5;\r\n  padding: 10px 10px;\r\n  border-radius: 20px;\r\n  overflow-x: hidden;\r\n  word-wrap: break-word;\r\n}\r\n.received img {\r\n  height: 40px;\r\n  width: 40px;\r\n  border-radius: 20px;\r\n  margin-right: 8px;\r\n}\r\n.chat-user {\r\n  display: flex;\r\n  align-items: center;\r\n  padding: 10px 15px;\r\n}\r\n.chat-user:hover {\r\n  background-color: #eeeeee;\r\n  text-decoration: none;\r\n}\r\n.chat-user > div {\r\n  display: flex;\r\n  max-width: 90%;\r\n  flex: 1;\r\n  justify-content: space-between;\r\n  min-width: 0;\r\n  overflow: hidden;\r\n}\r\n.chat-user > div > div + div {\r\n  max-width: 100%;\r\n  display: flex;\r\n  flex: 1;\r\n  flex-direction: column;\r\n  justify-content: space-between;\r\n  min-width: 0;\r\n  overflow: hidden;\r\n}\r\n.chat-user > div > div > span + span {\r\n  overflow: hidden;\r\n  text-overflow: ellipsis;\r\n  white-space: nowrap;\r\n  overflow: hidden;\r\n  color: #9f9f9f;\r\n}\r\n</style>\r\n","import { apiHelper } from \"./../utils/helpers.js\";\r\n\r\nexport default {\r\n  getMessages({ chattingUserId }) {\r\n    return apiHelper.get(`/messages/${chattingUserId}`);\r\n  },\r\n};\r\n","import { render } from \"./Chat.vue?vue&type=template&id=17bd4dfe\"\nimport script from \"./Chat.vue?vue&type=script&lang=js\"\nexport * from \"./Chat.vue?vue&type=script&lang=js\"\n\nimport \"./Chat.vue?vue&type=style&index=0&lang=css\"\nscript.render = render\n\nexport default script","'use strict';\nvar $ = require('../internals/export');\nvar $find = require('../internals/array-iteration').find;\nvar addToUnscopables = require('../internals/add-to-unscopables');\n\nvar FIND = 'find';\nvar SKIPS_HOLES = true;\n\n// Shouldn't skip holes\nif (FIND in []) Array(1)[FIND](function () { SKIPS_HOLES = false; });\n\n// `Array.prototype.find` method\n// https://tc39.es/ecma262/#sec-array.prototype.find\n$({ target: 'Array', proto: true, forced: SKIPS_HOLES }, {\n  find: function find(callbackfn /* , that = undefined */) {\n    return $find(this, callbackfn, arguments.length > 1 ? arguments[1] : undefined);\n  }\n});\n\n// https://tc39.es/ecma262/#sec-array.prototype-@@unscopables\naddToUnscopables(FIND);\n","export { default } from \"-!../../node_modules/mini-css-extract-plugin/dist/loader.js??ref--6-oneOf-1-0!../../node_modules/css-loader/dist/cjs.js??ref--6-oneOf-1-1!../../node_modules/vue-loader-v16/dist/stylePostLoader.js!../../node_modules/postcss-loader/src/index.js??ref--6-oneOf-1-2!../../node_modules/cache-loader/dist/cjs.js??ref--0-0!../../node_modules/vue-loader-v16/dist/index.js??ref--0-1!./Chat.vue?vue&type=style&index=0&lang=css\"; export * from \"-!../../node_modules/mini-css-extract-plugin/dist/loader.js??ref--6-oneOf-1-0!../../node_modules/css-loader/dist/cjs.js??ref--6-oneOf-1-1!../../node_modules/vue-loader-v16/dist/stylePostLoader.js!../../node_modules/postcss-loader/src/index.js??ref--6-oneOf-1-2!../../node_modules/cache-loader/dist/cjs.js??ref--0-0!../../node_modules/vue-loader-v16/dist/index.js??ref--0-1!./Chat.vue?vue&type=style&index=0&lang=css\""],"sourceRoot":""}